<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset=utf-8 />
 <title>Messaging Demos</title>
</head>

<body>

<h2>Broadcast Demo</h2>
<p>Test a basic broadcast. All users on this page will receive all messages sent by all other users.</p>
<div id="broadcast_status">Not initialized</div>
<form id="broadcast-form">
  <input type="text" id="sender" placeholder="type name">
  <input type="text" id="message" placeholder="type message">
  <input type="submit" value="Send">
</form>
<ul id="broadcast-messages"></div>



<script>

function get_appropriate_ws_url()
{
  var pcol;
  var u = document.URL;

  /*
   * We open the websocket encrypted if this page came on an
   * https:// url itself, otherwise unencrypted
   */

  if (u.substring(0, 5) == "https") {
    pcol = "wss://";
    u = u.substr(8);
  } else {
    pcol = "ws://";
    if (u.substring(0, 4) == "http")
      u = u.substr(7);
  }

  u = u.split('/');

  return pcol + u[0] + "/socketeer";
}

/* broadcast protocol */
var broadcast_socket = new WebSocket(
  get_appropriate_ws_url(),
  "broadcast-protocol");

try {
  broadcast_socket.onopen = function() {
    var broadcast_status = document.getElementById("broadcast_status");
    broadcast_status.style.backgroundColor = "#40ff40";
    broadcast_status.innerHTML = "websocket connection opened";
  }

  broadcast_socket.onmessage = function got_packet(msg) {
    message_list = document.getElementById("broadcast-messages");
    message = document.createElement("li");
    message.textContent = msg.data;
    message_list.appendChild(message);
  }

  broadcast_socket.onclose = function() {
    broadcast_status = document.getElementById("broadcast_status");
    broadcast_status.style.backgroundColor = "#ff4040";
    broadcast_status.innerHTML = "websocket connection CLOSED";
  }

  var broadcast_form = document.getElementById("broadcast-form");
  broadcast_form.addEventListener("submit", function(e) {
    e.preventDefault();
    var broadcast_user_input  = document.getElementById("sender");
    var broadcast_msg_input = document.getElementById("message");
    var broadcast_user = broadcast_user_input.value;
    var broadcast_message = broadcast_msg_input.value;
    console.log(broadcast_user + " sends: " + broadcast_message);
    broadcast_socket.send(broadcast_user + ": " + broadcast_message);
    broadcast_msg_input.value = "";
  }, false);


} catch(exception) {
  alert('<p>Error' + exception);
}

</script>

</body>
</html>
